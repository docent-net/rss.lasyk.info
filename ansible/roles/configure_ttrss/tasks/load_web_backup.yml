- name: Check if directory exists
  stat:
    path: "/srv/{{ rss_hostname }}"
  register: www_directory

- block:
  - name: Download web backup from Cloud storage
    # not using ansible gc_storage module as it doesn't support
    # service-account/IAM roles authentication that are assigned to
    # GCE instances
    command: gsutil cp gs://{{ gcp.cloud_storage_bucket_name }}/backups/{{ rss_hostname }}-latest.tar.gz /srv/{{ rss_hostname }}-latest.tar.gz
    changed_when: false

  - name: Unarchive backup
    unarchive:
      dest: /srv
      owner: nginx
      group: nginx
      mode: 0770
      src: "/srv/{{ rss_hostname }}-latest.tar.gz"

  - name: Cleanup
    file:
      path: "/srv/{{ rss_hostname }}-latest.tar.gz"
      state: absent

  - name: Rename old config.php
    command: mv /srv/{{ rss_hostname }}/config.php /srv/{{ rss_hostname }}/config.php.tpl
    args:
      creates: "/srv/{{ rss_hostname }}/config.php.tpl"

  when: www_directory.stat.exists == false